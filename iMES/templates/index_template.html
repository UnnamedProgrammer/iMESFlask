<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='/css/bootstrap.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='/css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='/css/preload.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='/css/icons.css') }}">
    <title>TERMINAL IPLAST</title>
</head>

<body ondragstart="return false;" ondrop="return false;">
    <script src="{{url_for('static', filename='/js/jquery-3.6.0.min.js')}}"></script>
    <input type="hidden" id="current_user" value="{{ current_user }}">
    {% block navbar %} {% endblock %}
    <div class="main-page container">
        <div class="row">
            <div class="col-2">
                <div class="card height120 shadow green">
                    <div class="card-body" style="padding: 0.9rem 1.25rem">
                        <p class="card-text text-center" id="ttpa" data-oid="{{ current_tpa[0] }}">{{ current_tpa[1] }}</p>
                    </div>
                </div>
                <div class="card height150 shadow">
                    <div class="card-header text-center primary">ПРЕСС-ФОРМА</div>
                    <div class="card-body nopadding">
                        <p class="card-text text-center fw-bold" id="tpf"></p>
                    </div>
                </div>
                <div class="card height150 shadow">
                    <div class="card-header text-center primary">ПРОДУКТ</div>
                    <p class="card-text text-center nopadding fw-bold" id="tprod"></p>
                    <div class="card-body nopadding">
                    </div>
                </div>
                <div class="card height120 shadow">
                    <div class="card-header text-center primary">ПЛАН ПО ПРОД.</div>
                    <div class="card-body nopadding d-flex align-items-center justify-content-center">
                        <p class="card-text text-center nplan" id="nplan"></p>
                    </div>
                </div>
                <div class="card height120 shadow">
                    <div class="card-header text-center card-h-uppercase primary">ВЫПУЩЕНО ПРОД.</div>
                    <div class="card-body nopadding d-flex align-items-center justify-content-center">
                        <p class="card-text text-center nvplan" id="nvplan"></p>
                    </div>
                </div>
                <div class="card height120 shadow">
                    <div class="card-header text-center card-h-uppercase primary">БРАК</div>
                    <div class="card-body nopadding d-flex align-items-center justify-content-center">
                        <p class="card-text text-center nvDefect" id="nvDefect"></p>
                    </div>
                </div>
            </div>
            <div class="col-8">
                <div class="main-window" style="position: relative;">
                    <div class="preloader">

                        <!-- Добавляем готовую структуру Preloader -->
                        <div class="sk-chase">
                          <div class="sk-chase-dot"></div>
                          <div class="sk-chase-dot"></div>
                          <div class="sk-chase-dot"></div>
                          <div class="sk-chase-dot"></div>
                          <div class="sk-chase-dot"></div>
                          <div class="sk-chase-dot"></div>
                        </div>
                    </div>
                    {% block main_window %}                
                    {% endblock %}
                </div>

                {% block access_blocked %} {% endblock %}

                <div class="row">
                    <div class="col-6">
                        <span class="badge user-badge">Оператор</span>
                        <div class="card user-card height100 shadow primary" id="colorOperator">
                            <div class="card-body nopadding">
                                <p id="operator" class="card-text text-right user-fio"></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <span class="badge user-badge">Наладчик</span>
                        <div class="card user-card height100 shadow accent" id="colorAdjuster">
                            <div class="card-body nopadding">
                                <p id="adjuster"  class="card-text user-fio"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-2">
                <div class="card height200 shadow">
                    <div class="card-header text-center primary">ПЛАНОВЫЙ ЦИКЛ</div>
                    <div class="card-body nopadding">
                        <p class="card-text text-center display-3" id="pointTC"></p>
                    </div>
                </div>
                <div class="card height200 shadow">
                    <div class="card-header text-center primary">ЦИКЛ ЗА СМЕНУ</div>
                    <div class="card-body nopadding">
                        <p class="card-text text-center display-3" id="pointVCS"></p>
                    </div>
                </div>
                <div class="card height200 shadow">
                    <div class="card-header text-center primary">ПЛАНОВЫЙ ВЕС</div>
                    <div class="card-body nopadding d-flex align-items-center justify-content-center">
                        <p class="card-text text-center display-3" id="planweight"></p>
                    </div>
                </div>
                <div class="card height200 shadow">
                    <div class="card-header text-center card-h-uppercase primary">СРЕДНИЙ ВЕС</div>
                    <div class="card-body nopadding d-flex align-items-center justify-content-center">
                        <p class="card-text text-center display-3" id="average_weigth">
                            0
                        </p>
                    </div>
                </div>
                <div class="card height100 shadow">
                    <div class="card-body nopadding primary">
                        <p class="card-text text-center" id="smena"></p>
                    </div>
                </div>
            </div>
            <div class="row footer">
                <div class="col-2">
                    <div class="card height-bottom shadow">
                        <div class="card-body primary">
                            <p class="card-text text-center" id="clock"></p>
                        </div>
                    </div>
                </div>
                <div class="col-2">
                    <div class="card height-bottom shadow width-bottom">
                        <div class="card-header text-center nopadding primary">ВЫПОЛНЕНИЕ ПЛАНА ЧЕРЕЗ:</div>
                        <div class="card-body nopadding">
                            <p class="card-text text-center display-5">03:42:56</p>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    {%if current_user.is_authenticated and current_user.device_type == 'Веб'%}
                        <a href="/menu">
                            <div class="card height-bottom shadow">
                                <div class="accent left-padding">УКАЖИТЕ ПРИЧИНУ ПРОСТОЯ</div>
                            </div>
                        </a>
                    {%else%}
                        <a>
                            <div class="card height-bottom shadow">
                                <div class="accent left-padding">УКАЖИТЕ ПРИЧИНУ ПРОСТОЯ</div>
                            </div>
                        </a>
                    {%endif%}
                </div>
                <div class="col-2">
                    <div class="card height-bottom shadow">
                        <div class="card-header text-center nopadding primary">БУМАГИ В ПРИНТЕРЕ ДЛЯ ПЕЧАТИ:</div>
                        <div class="card-body nopadding ">
                            <p class="card-text text-center display-4"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% block navbar_footer %}
        
    {% endblock %}
</body>
<script src="{{url_for('static', filename='/js/socket.io.js')}}"></script>
<script src="{{url_for('static', filename='/js/main.js')}}"></script>
<script>
        address = "{{request.remote_addr}}"
        devicetype = "Терминал"
        var socket = io();
        socket.on('connect', function () {
            socket.emit('connecting', { data: 'I\'m connected!' });
        });
        socket.emit('getTpaList', { ipaddress: address });
        socket.emit('GetDeviceType', '');
        socket.on('Auth',function(data) {
            arr = JSON.parse(data)
            if (address == Object.keys(arr)[0]) {
                window.location.href = '/Auth'
            }
        })

        // Дата и время 
        timecounter = 0
        function formatDate(date) {

            let dd = date.getDate();
            if (dd < 10) dd = '0' + dd;

            let mm = date.getMonth() + 1;
            if (mm < 10) mm = '0' + mm;

            let yy = date.getFullYear();

            return dd + '.' + mm + '.' + yy;
        }
        function getCurrentTimeString() {
            "{% if current_user.is_authenticated == True %}"
            if (timecounter <= 120 && devicetype != 'Веб'){
                timecounter += 1
            }
            else
            {
                if(devicetype == "Терминал")
                {
                    window.location.href = '/logoutWithoutDeleteRoles'
                }
            }
            "{% else %}"
            "{% endif %}"
            return formatDate(new Date()) + " " + new Date().toTimeString().replace(/ .*/, '');
        }
        window.onload = function () {
            let timeNode = document.getElementById('clock');

            setInterval(
                () => timeNode.innerHTML = getCurrentTimeString(),
                1000
            );
        }
        
        /* Атакишиев f-0005d для страницы /tableWeight НАЧАЛО */
        /* Добавление строк в таблицу */
        socket.on('table_weight', function(data) {
            table_column = JSON.parse(data);
            if (address == Object.values(table_column)[0]) {
                $(".table_ProductWeight").append('<tr><td>' + table_column['data'][0] + '</td><td>' + table_column['data'][1] + '</td><td>' + table_column['data'][2] + '</td><td>' + table_column['data'][3] + '</td></tr>');
            }
        })
        /* Формирование текста для печатной формы */
        socket.on('print_weight', function(data) {
            print_info = JSON.parse(data);
            if (address == Object.values(print_info)[0]) {
                $(".print_ProductWeight").append(print_info['head_data'][0] + '\n' + print_info['head_data'][1])
                
                for (let i = 0; i < Object.keys(print_info['body_data']).length; i++) {
                    $(".print_ProductWeight").append(print_info['body_data'][i][0] + ' ' + print_info['body_data'][i][1])
                }
            }
        })
        /* Атакишиев f-0005d для страницы /tableWeight КОНЕЦ */
        socket.on('AnswerAfterConnection', function (data) {
            arr = JSON.parse(data)
            if (address == Object.keys(arr)[0]) {
                let roles = []
                for (let i = 0; i < Object.keys(arr[address]).length; i++) {
                    roles.push(arr[address][i])
                }
                if (roles.length > 1) {
                    window.location.href = '/menu';
                }
                if (roles[0] == "Оператор" && roles.length == 1) {
                    window.location.href = '/operator';
                }
                if (roles[0] == "Наладчик" && roles.length == 1) {
                    window.location.href = '/adjuster';
                };
            }
        });
        socket.on('DeviceType', function(data){
            arr = JSON.parse(data)
            if (address == Object.keys(arr))
            {
                devicetype = arr[address]
            }
        })

        socket.on('GetMainWindowData', function(data){
            arr = JSON.parse(data)
            if (address == Object.keys(arr))
            {
                console.log(arr[address])
                let pressform = document.getElementById('tpf')
                let product = document.getElementById('tprod')
                let product_plan = document.getElementById('nplan')
                let product_fact = document.getElementById('nvplan')
                let cycle = document.getElementById('pointTC')
                let cycle_fact = document.getElementById('pointVCS')
                let plan_weight = document.getElementById('planweight')
                let average_weight = document.getElementById('average_weigth')
                let shift = document.getElementById('smena')
                let defective = document.getElementById('nvDefect')

                pressform.textContent = arr[address]['PF']
                product.textContent = arr[address]['Product']
                product_plan.textContent = arr[address]['Plan']
                product_fact.textContent = arr[address]['Fact']
                cycle.textContent = arr[address]['PlanCycle']
                cycle_fact.textContent = arr[address]['FactCycle']
                plan_weight.textContent = arr[address]['PlanWeight']
                average_weight.textContent = arr[address]['AverageWeight']
                shift.textContent = arr[address]['Shift']
                defective.textContent = arr[address]['Defective']
            }
        })

        async function UpdateMainWindowData(){
            while(true)
            {
                socket.emit('NeedUpdateMainWindowData', { data: '' })
                await sleep(3000)
            }           
        }
        UpdateMainWindowData()
</script>
<script>
    window.addEventListener('load', () => { 
        const preloader = document.querySelector('.preloader')
        preloader.classList.add('preloader_hidden')
    })
    function LinkClick() {
        const preloader = document.querySelector('.preloader')
        preloader.classList.remove('preloader_hidden')
    }
</script>
<script>
function RequestOperatorAndAdjuster() {
    let url = "http://"+window.location.host + "/getOperatorAndAdjuster"
    let request = new XMLHttpRequest()
    request.open("GET",url)
    request.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    request.addEventListener("readystatechange", () => {
        if (request.readyState === 4 && request.status === 200) {
            OperatorAndAdjuster = JSON.parse(request.responseText);
            let operator = document.getElementById('operator');
            let adjuster = document.getElementById('adjuster');
            operator.textContent = OperatorAndAdjuster['Оператор']
            adjuster.textContent = OperatorAndAdjuster['Наладчик']
        }
    });
    request.send()
}
RequestOperatorAndAdjuster()
</script>
{% block script %}                
{% endblock %}
</html>